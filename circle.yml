machine:
  pre:
    - sudo sh -c "echo 'DOCKER_OPTS=\"\$DOCKER_OPTS --insecure-registry docker-registry.arimit.su\"' >> /etc/default/docker"
  services:
    - docker
test:
  override:
    - envsubst '${DOCKER_REGISTRY_HOST_NAME} ${ASF_SITE_HOST_NAME}' < usr/local/nginx/conf/nginx.conf.template > usr/local/nginx/conf/nginx.conf.generated
    - echo ${DOCKER_REGISTRY_AUTH_CREDENTIAL} > docker-registry.htpasswd.generated
    - docker build --tag="docker-registry.arimit.su/sxend/internal-reverse-proxy:${CIRCLE_SHA1}" .
deployment:
  release:
    branch: master
    commands:
      - docker push docker-registry.arimit.su/sxend/internal-reverse-proxy:${CIRCLE_SHA1}
